# IPv4

## Purpose

The IPv4 protocol implements:

- addressing of packets
- fragmentation (and reassembly) of packets

## IPv4 Addresses

An IPv4 address is a 32-bit non-negative integer:

```
00001010000000000000000011111111
```

This is obviously unreadable, which is why we normally represent IP addresses in dooted-quad (dotted-decimal) notation.
We take the 4 8-bit numbers:

```
00001010 00000000 00000000 11111111
```

And we write them as decimal numbers with dots between them:

```
10.0.0.255
```

Since each number is 8 bits, each number will be in the range [0, 255].

Linux kernel struct (see `include/uapi/linux`):

```c
struct in_addr {
	__be32	s_addr;
};
```

Note that `__be32` is basically just `unsigned int`.

IP address space is allocated by a collection fo hierarchically organized authorities.

IANA (top of the hierachy) delegates mostly to RIRs (regional Internet registrars).
RIRs coordinate through NRO (Number Resource Organization).
RIRs allocate address space to smaller registries operating in countries and large ISPs.
ISPs provide spaces to customers.

Use WHOIS to determine how address space has been allocated.

## Subnet Masks

Subnet masks are used by routers and hosts to determine where the network portion of an IP address ends and the host part begins.

A subnet mask is a 32-bit non-negative integer (structured like IPv4 address), containing 1s followed by 0s.
The 1s mean that the corresponding bit position in an IP address is part of the network portion and the 0s mean that the corresponding bit is part of the host portion.

Sometimes subnet masks are written as prefix length notation, which is the number of contiguous 1 bits in the mask.
Consider this subnet mask:

```
255.0.0.0
```

It has a binary representation:

```
11111111 00000000 00000000 00000000
```

This has the prefix length `/8` (because there are 8 contiguous ones).

## Special Addresses

These are not available as unicast addresses.

### Broadcast Addresses

A broadcast address addresses all hosts in a network.

Formed by setting all host field bits to 1.

For example if adress is `128.32.1.17` and mask is `255.255.255.0` (`/24`), then the broadcast address is `128.32.1.255`.

Note that broadcasts are problematic from a security point of view and are often disabled.

### Multicast Addresses

Identifies a group of host interfaces.
The portion of the network covered is a scope:

- node-local (same computer)
- link-local (same subnet)
- site-local (applicable to some site)
- global (entire Internet)
- administrative

All hosts should receive datagrams sent to the group.

- ASM vs SSM

### Anycast Addresses

Most appropriate host unicast, usually used for most common service (e.g. DNS)

## Header

See RFC791.

Explanation:

- version = 4 for IPv4
- IHL = Internet Header Length → can be used to determine where the header ends and the data begins
- Type of Service is now Differentiated Services Field (used for streaming etc)
- Total Length = entire size of packet
- Identification = used to allow assembling fragmented packets
- Flags:
  - May Fragment
  - Last Fragment
  - Fragment Offset
- Time To Live = maximum time packet is allowed to live → usually decreased along the way & packet is discarded if it reaches 0
- Protocol = next level protocol, e.g. 1 = ICMP, 6 = TCP
- Header Checksum
- source address
- destination address

## The `ip` Protocol

Most important subtools:

- `ip route` to display and manipulate (add/change/delete) kernel IP routing tables
- `ip link` to display and manipulate network interfaces
- `ip addr` to display and manipulate IP addresses assigned to network interfaces

Show all network interfaces:

```sh
ip a show
```

Note that you can also use `ifconfig` (part of `net-tools`), however `ip` (part of `ifconfig2`) is newer, read e.g. [Moving on from net-tools](https://lwn.net/Articles/710533/).

## Virtual Example

Assign IP address to network interface:

```sh
ip addr add $IP dev $INTERFACE
```

Enable interface:

```sh
ip link set $INTERFACE up
```

Route:

```sh
ip route add $ROUTE via $IP
```

Alternatively you can do:

```sh
ip route show
```

Example routing table:

```sh
default via 192.168.178.1 dev wlp4s0 proto dhcp metric 600
169.254.0.0/16 dev wlp4s0 scope link metric 1000
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
172.18.0.0/16 dev br-f93b5daa6cd2 proto kernel scope link src 172.18.0.1 linkdown
192.168.178.0/24 dev wlp4s0 proto kernel scope link src 192.168.178.47 metric 600
```

Explanation:

- `default via 192.168.178.1 dev wlp4s0 proto dhcp metric 600` = default route (when no other routes match destination IP), packets should be sent via 192.168.178.1 gateway, use wlp4s0 interface, route was added by DHCP
- `169.254.0.0/16 dev wlp4s0 scope link metric 1000` = link-local route

Add a route:

```sh
sudo ip route add 142.251.37.14 via 192.168.178.2 dev wlp4s0
```

Delete a route:

```sh
sudo ip route del 142.251.37.14
```

Show route:

```sh
ip route get 142.251.37.14
```
